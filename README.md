# k8s-cka

- é›†ç¾¤æ¶æ„ï¼Œå®‰è£…å’Œé…ç½®ï¼š25%
- å·¥ä½œè´Ÿè½½å’Œè°ƒåº¦ï¼š15%
- æœåŠ¡å’Œç½‘ç»œï¼š20%
- å­˜å‚¨ï¼š10%
- æ•…éšœæ’é™¤ï¼š30%

> æœ‰äº†Dockerä»¥åï¼Œä¸ºä»€ä¹ˆè¿˜è¦ç”¨K8sï¼Ÿ

`ä¼ä¸šéœ€æ±‚`ï¼šä¸ºæé«˜ä¸šåŠ¡å¹¶å‘å’Œé«˜å¯ç”¨ï¼Œä¼šä½¿ç”¨å¤šæ€æœåŠ¡å™¨é›†ç¾¤ã€‚

- å¤šå®¹å™¨è·¨ä¸»æœºæä¾›æœåŠ¡
- å¤šå®¹å™¨åˆ†éƒ¨èŠ‚ç‚¹éƒ¨ç½²
- å¤šå®¹å™¨æ€ä¹ˆå‡çº§éƒ¨ç½²
- é«˜æ•ˆç®¡ç†è¿™äº›å®¹å™¨

![001](images/001.png)

> K8sæ˜¯ç”¨äºå®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„éƒ¨ç½²ã€æ‰©å±•å’Œç®¡ç†ï¼Œç›®æ ‡æ˜¯è®©éƒ¨ç½²å®¹å™¨åŒ–åº”ç”¨ç®€å•é«˜æ•ˆã€‚

![002](images/002.png)

## K8sé›†ç¾¤æ¶æ„ä¸ç»„ä»¶

### Masterç»„ä»¶

- `kube-apiserver`

`Kubernetes API`ï¼Œé›†ç¾¤çš„ç»Ÿä¸€å…¥å£ï¼Œå„ç»„ä»¶åè°ƒè€…ï¼Œä»¥ `RESTful API` æä¾›æ¥å£æœåŠ¡ï¼Œæ‰€æœ‰å¯¹è±¡èµ„æºçš„å¢åˆ æ”¹æŸ¥å’Œç›‘å¬æ“ä½œéƒ½äº¤ç»™ `API-Server` å¤„ç†åå†æäº¤ç»™ Etcd å­˜å‚¨ã€‚

- `kube-controller-manager`

å¤„ç†æ€¥ç¾¤ä¼—å¸¸è§„åå°ä»»åŠ¡ï¼Œä¸€ä¸ªèµ„æºå¯¹åº”ä¸€ä¸ªæ§åˆ¶å™¨ï¼Œè€Œ ControllerManager å°±æ˜¯è´Ÿè´£ç®¡ç†è¿™äº›æ§åˆ¶å™¨çš„ã€‚

- `kube-schdeuler`

æ ¹æ®è°ƒåº¦ç®—æ³•ä¸ºæ–°åˆ›å»ºçš„ `Pod` é€‰æ‹©ä¸€ä¸ª `Node` èŠ‚ç‚¹ï¼Œå¯ä»¥ä»»æ„éƒ¨ç½²ï¼Œå¯ä»¥éƒ¨ç½²åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œä¹Ÿå¯ä»¥éƒ¨ç½²åœ¨ä¸åŒçš„èŠ‚ç‚¹ä¸Šã€‚

- etcd

åˆ†å¸ƒå¼å‡å€¼å­˜å‚¨ç³»ç»Ÿã€‚ç”¨äºä¿å­˜é›†ç¾¤çŠ¶æ€æ•°æ®ï¼Œæ¯”å¦‚ `Pod`ã€`Service` ç­‰å¯¹è±¡ä¿¡æ¯ã€‚

### Nodeç»„ä»¶

- kubelet

`kublet` æ˜¯ `Master` åœ¨NodeèŠ‚ç‚¹ä¸Šçš„ `Agent`ï¼Œç®¡ç†æœ¬æœºè¿è¡Œå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ¯”å¦‚åˆ›å»ºå®¹å™¨ã€PodæŒ‚è½½æ•°æ®å·ã€ä¸‹è½½secretã€è·å–å®¹å™¨å’ŒèŠ‚ç‚¹çŠ¶æ€ç­‰å·¥ä½œã€‚`kubelet` å°†æ¯ä¸ª `Pod` è½¬æ¢æˆä¸€ç»„å®¹å™¨ã€‚

- kube-proxy

åœ¨ `Node` èŠ‚ç‚¹ä¸Šå®ç° `Pod` ç½‘ç»œä»£ç†ï¼Œç»´æŠ¤ç½‘ç»œè§„åˆ™å’Œå››å±‚è´Ÿè½½å‡è¡¡å·¥ä½œã€‚

- docker æˆ– rocket

å®¹å™¨å¼•æ“ï¼Œè¿è¡Œå®¹å™¨ã€‚

## K8sé›†ç¾¤æ­å»º

ç”Ÿæˆç¯å¢ƒéƒ¨ç½²k8sçš„ä¸¤ç§æ–¹å¼

- `kubeadm`

Kubeadmæ˜¯ä¸€ä¸ªå·¥å…·ï¼Œæä¾› kubeadm init å’Œ kubeadm joinï¼Œç”¨äºå¿«é€Ÿéƒ¨ç½²k8sé›†ç¾¤

- `äºŒè¿›åˆ¶`

ğŸ’¯ æ¨èï¼Œä»å®˜æ–¹ä¸‹è½½å‘è¡Œç‰ˆçš„äºŒè¿›åˆ¶åŒ…ï¼Œæ‰‹åŠ¨éƒ¨ç½²æ¯ä¸ªç»„ä»¶ï¼Œç»„ä»¶k8sé›†ç¾¤

> éƒ¨ç½² `k8s` æ—¶å¿…é¡»å…³é—­ `swap`
>
> kubeadm ç»„ä»¶å®¹å™¨åŒ–éƒ¨ç½²ï¼ˆé•œåƒï¼‰ï¼Œkubeletæ²¡æœ‰å®¹å™¨åŒ–ï¼Œä½¿ç”¨systemctlç®¡ç†ï¼Œæœ‰å®ˆæŠ¤è¿›ç¨‹

- æœåŠ¡å™¨ç¡¬ä»¶æ¨èé…ç½®
- ä½¿ç”¨kubeadmå¿«é€Ÿéƒ¨ç½²ä¸€ä¸ªk8sé›†ç¾¤
- k8s CNI ç½‘ç»œæ¨¡å‹
- kubectl å‘½ä»¤è¡Œç®¡ç†å·¥å…·

### kubeadm initå·¥ä½œæµç¨‹

1. å®‰è£…ç¯å¢ƒæ£€æŸ¥ï¼Œä¾‹å¦‚swapoffæœ‰æ²¡æœ‰å…³ã€æœºå™¨é…ç½®ç¬¦åˆä¸ç¬¦åˆ
2. ä¸‹è½½é•œåƒ kubeadm config images pull
3. ç”Ÿæˆè¯ä¹¦ï¼Œä¿å­˜è·¯å¾„/etc/kubernetes/pkiï¼ˆk8sã€etcdï¼‰
4. [kubeconfig] ç”Ÿæˆkubeconfigæ–‡ä»¶
5. [kubelet-start] ç”Ÿæˆkubeleté…ç½®æ–‡ä»¶å¹¶å¯åŠ¨
6. [control-plane] å¯åŠ¨masterèŠ‚ç‚¹ç»„ä»¶
7. å°†ä¸€äº›é…ç½®æ–‡ä»¶å­˜å‚¨åˆ°configmapä¸­ï¼Œç”¨äºå…¶ä»–èŠ‚ç‚¹åˆå§‹æ‹‰å–
8. [mark-control-plane] ç»™masterèŠ‚ç‚¹æ‰“æ±¡ç‚¹ï¼Œä¸è®©podåœ¨ä¸Šé¢è¿è¡Œ
9. [bootstrap-token] è‡ªåŠ¨ä¸ºkubeleté¢å‘è¯ä¹¦
10. [addons] å®‰è£…æ’ä»¶ CoreDNS kube-proxy

## ä½¿ç”¨kubeadmå¿«é€Ÿæ­å»ºk8sé›†ç¾¤

```bash
# åˆ›å»ºä¸€ä¸ª Master èŠ‚ç‚¹
kubeadm init


# å°†ä¸€ä¸ª Node èŠ‚ç‚¹åŠ å…¥åˆ°æŒ‡å®šé›†ç¾¤é‡Œ
kubeadm join <MasterèŠ‚ç‚¹çš„ipå’Œport>
```

### 1. å®‰è£…è¦æ±‚

åœ¨å¼€å§‹ä¹‹å‰ï¼Œéƒ¨ç½²Kubernetesé›†ç¾¤æœºå™¨éœ€è¦æ»¡è¶³ä»¥ä¸‹å‡ ä¸ªæ¡ä»¶ï¼š

- ä¸€å°æˆ–å¤šå°æœºå™¨ï¼Œæ“ä½œç³»ç»Ÿ CentOS7.x-86_x64
- ç¡¬ä»¶é…ç½®ï¼š2GBæˆ–æ›´å¤šRAMï¼Œ2ä¸ªCPUæˆ–æ›´å¤šCPUï¼Œç¡¬ç›˜30GBæˆ–æ›´å¤š
- é›†ç¾¤ä¸­æ‰€æœ‰æœºå™¨ä¹‹é—´ç½‘ç»œäº’é€š
- å¯ä»¥è®¿é—®å¤–ç½‘ï¼Œéœ€è¦æ‹‰å–é•œåƒ
- ç¦æ­¢swapåˆ†åŒº

### 2. å‡†å¤‡ç¯å¢ƒ

| è§’è‰²       | IP            |
| ---------- | ------------- |
| k8s-master | 192.168.31.61 |
| k8s-node1  | 192.168.31.62 |
| k8s-node2  | 192.168.31.63 |

```bash
å…³é—­é˜²ç«å¢™ï¼š
$ systemctl stop firewalld
$ systemctl disable firewalld

å…³é—­selinuxï¼š
$ sed -i 's/enforcing/disabled/' /etc/selinux/config  # æ°¸ä¹…
$ setenforce 0  # ä¸´æ—¶

å…³é—­swapï¼š
$ swapoff -a  # ä¸´æ—¶
$ vim /etc/fstab  # æ°¸ä¹…

è®¾ç½®ä¸»æœºåï¼š
$ hostnamectl set-hostname <hostname>

åœ¨masteræ·»åŠ hostsï¼š
$ cat >> /etc/hosts << EOF
192.168.31.61 k8s-master
192.168.31.62 k8s-node1
192.168.31.63 k8s-node2
EOF

å°†æ¡¥æ¥çš„IPv4æµé‡ä¼ é€’åˆ°iptablesçš„é“¾ï¼š
$ cat > /etc/sysctl.d/k8s.conf << EOF
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF
$ sysctl --system  # ç”Ÿæ•ˆ

æ—¶é—´åŒæ­¥ï¼š
$ yum install ntpdate -y
$ ntpdate time.windows.com
```

### 3. å®‰è£…Docker/kubeadm/kubeletã€æ‰€æœ‰èŠ‚ç‚¹ã€‘

Kubernetesé»˜è®¤CRIï¼ˆå®¹å™¨è¿è¡Œæ—¶ï¼‰ä¸ºDockerï¼Œå› æ­¤å…ˆå®‰è£…Dockerã€‚

#### 3.1 å®‰è£…Docker

- å»DigitalOceanç¿»æ•™ç¨‹ï¼Œé‚£é‡Œæœ€å¥½
- é…ç½®é•œåƒä¸‹è½½åŠ é€Ÿå™¨

## k8s CNIç½‘ç»œæ¨¡å‹

![003](images/003.jpg)

è§£å†³çš„é—®é¢˜ï¼š

- 1.ç»Ÿä¸€ç®¡ç†è¿™äº›k8s nodeç½‘æ®µï¼Œä¿éšœæ¯ä¸ªå®¹å™¨åˆ†é…ä¸ä¸€æ ·çš„ipåœ°å€
- 2.è¦çŸ¥é“è½¬å‘ç»™å“ªä¸ªdockerä¸»æœºï¼Ÿ
- 2.æ€ä¹ˆå®ç°è¿™ä¸ªè½¬å‘(ä»dockerä¸»æœº1çš„å®¹å™¨Aè½¬å‘åˆ°å¦ä¸€å°dockerä¸»æœº2çš„å®¹å™¨Î²)

CNI (Container Network Interface, å®¹å™¨ç½‘ç»œæ¥å£): æ˜¯ä¸€ä¸ªå®¹å™¨ç½‘ç»œè§„èŒƒï¼Œk8sç½‘ç»œå°±æ˜¯é‡‡ç”¨CNIè§„èŒƒã€‚

**k8sæ˜¯ä¸€ä¸ªæ‰å¹³åŒ–ç½‘ç»œã€‚**

> å³æ‰€æœ‰éƒ¨ç½²çš„ç½‘ç»œç»„ä»¶éƒ½å¿…é¡»æ»¡è¶³å¦‚ä¸‹è¦æ±‚ï¼š

- ä¸€ä¸ª `Pod` ä¸€ä¸ª `IP`
- æ‰€æœ‰çš„ Pod å¯ä»¥ä¸ä»»ä½•å…¶ä»– Pod ç›´æ¥é€šä¿¡
- æ‰€æœ‰èŠ‚ç‚¹å¯ä»¥ä¸æ‰€æœ‰ Pod åŒæ—¶ç›´æ¥é€šä¿¡
- Pod å†…éƒ¨è·å–åˆ°çš„ IP åœ°å€ä¸å…¶ä»– Pod æˆ–è€…èŠ‚ç‚¹ä¸å…¶é€šä¿¡æ—¶çš„IPåœ°å€æ˜¯åŒä¸€ä¸ª

ä¸»æµç½‘ç»œç»„ä»¶æœ‰ï¼š `Flannel` `Calico` ç­‰
